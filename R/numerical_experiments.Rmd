---
title: "Other Simulations"
author: "Tianyi Liu"
date: "8/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
pacman::p_load(tidyverse, stringr, purrr, furrr, magrittr, zoo, patchwork)
source("./core_algorithm_functions_test.R")
source("./matrix_initiation_functions.R")
source("./utility_functions.R")
```

```{r}
set.seed(100)

# set the constants
n_genes <- 20
n_cell_types <- 5
n_subjects <- 50
n_known_genes <- 12
n_good_cell_types <- 4

## generate a G
G_true <- get_G(n_genes, n_subjects, n_cell_types, n_known_genes, n_good_cell_types)

## generate a C
C_true <- get_C(n_cell_types, n_subjects)

## generate an error matrix
E <- matrix(runif(n_genes * n_subjects), n_genes, n_subjects)

## generate an M
M <- G_true %*% C_true + E  

## get G0 from G
G0 <- matrix(0L, n_genes, n_cell_types)
G0[1:n_known_genes, 1:n_good_cell_types] <- G_true[1:n_known_genes, 1:n_good_cell_types]

## Get Delta; will be useful for getting all the norms
Delta <- get_Delta(n_cell_types, n_good_cell_types, n_genes, n_known_genes)
```

## Experiment 1:
We pull one value for each of the tuning parameter around the suitable range we discovered. Then, we contrast the solution of the two methods iteration by iteration, using `G_true` and `C_true` as initial values:

```{r exp1}
## one value for each parameter
a = 2^16
x = 16
b = 2^20

## run one numerical simulation
solve_direct <- PSMF_solve_test(
  M = M,
  G_0 = G0,
  G_init = G_true,
  C_init = C_true,
  n_markers = n_known_genes,
  n_good_cell_types = n_good_cell_types,
  alpha = a,
  xi = x,
  beta = b,
  eps = 1e-5,
  method = 'direct',
  Delta = Delta,
  G_true = G_true,
  C_true = C_true
)

solve_auxiliary <- PSMF_solve_test(
  M = M,
  G_0 = G0,
  G_init = G_true,
  C_init = C_true,
  n_markers = n_known_genes,
  n_good_cell_types = n_good_cell_types,
  alpha = a,
  xi = x,
  beta = b,
  eps = 1e-5,
  method = 'auxiliary',
  Delta = Delta,
  G_true = G_true,
  C_true = C_true
)
```

Collect the results:
```{r}
## output all the residuals we collected
direct_n_iter = solve_direct$n_iter 
direct_obj = solve_direct$obj
direct_M_res = solve_direct$M_res_vec
direct_G_res = solve_direct$G_res_vec %>% na.locf()
direct_C_res = solve_direct$C_res_vec %>% na.locf()
direct_C_colsum_res = solve_direct$C_colsum_res_vec %>% na.locf()
direct_G_fixed_res = solve_direct$G_fixed_res_vec %>% na.locf()

direct_df <- tibble(
  iter = 1:(direct_n_iter - 1),
  obj = direct_obj[-length(direct_obj)],
  M_res = direct_M_res[-length(direct_M_res)],
  G_res = direct_G_res,
  C_res = direct_C_res,
  G_fixed_res = direct_G_fixed_res,
  C_colsum_res = direct_C_colsum_res
)

aux_n_iter = solve_auxiliary$n_iter 
aux_obj = solve_auxiliary$obj
aux_M_res = solve_auxiliary$M_res_vec
aux_G_res = solve_auxiliary$G_res_vec %>% na.locf()
aux_C_res = solve_auxiliary$C_res_vec %>% na.locf()
aux_C_colsum_res = solve_auxiliary$C_colsum_res_vec %>% na.locf()
aux_G_fixed_res = solve_auxiliary$G_fixed_res_vec %>% na.locf()

aux_df <- tibble(
  iter = 1:(aux_n_iter),
  obj = aux_obj,
  M_res = aux_M_res,
  G_res = aux_G_res,
  C_res = aux_C_res,
  G_fixed_res = aux_G_fixed_res,
  C_colsum_res = aux_C_colsum_res
)
```

### Result 1: Differences of M_res, G_res, and C_res between two methods. 
```{r}
p0 <- direct_df %>% 
  ggplot(aes(x=iter, y=obj)) + 
  geom_line(col="green")

p0 <- p0 + 
  geom_line(data=aux_df, aes(x=iter, y=obj), col="red") +
  labs(
    title="Objectives",
    x="Iteration",
    y="Objective Function"
  )

p1 <- direct_df %>% 
  ggplot(aes(x=iter, y=M_res)) + 
  geom_line(col="green")

p1 <- p1 + 
  geom_line(data=aux_df, aes(x=iter, y=M_res), col="red") +
  labs(
    title="Residual of M",
    x="Iteration",
    y="||M - M_hat||_F"
  )

p2 <- direct_df %>% 
  ggplot(aes(x=iter, y=G_res)) + 
  geom_line(col="green")

p2 <- p2 + 
  geom_line(data=aux_df, aes(x=iter, y=G_res), col="red") +
  labs(
    title="Residual of G",
    x="Iteration",
    y="||G - G_hat||_F"
  )

p3 <- direct_df %>% 
  ggplot(aes(x=iter, y=C_res)) + 
  geom_line(col="green")

p3 <- p3 + 
  geom_line(data=aux_df, aes(x=iter, y=C_res), col="red") +
  labs(
    title="Residual of C",
    x="Iteration",
    y="||C - C_hat||_F"
  )

p4 <- direct_df %>% 
  ggplot(aes(x=iter, y=G_fixed_res)) + 
  geom_line(col="green")

p4 <- p4 + 
  geom_line(data=aux_df, aes(x=iter, y=G_fixed_res), col="red") +
  labs(
    title="Residual of Fixed Part of G",
    x="Iteration",
    y="||Delta * G_hat - C_0||_F"
  )

p5 <- direct_df %>% 
  ggplot(aes(x=iter, y=C_colsum_res)) + 
  geom_line(col="green")

p5 <- p5 + 
  geom_line(data=aux_df, aes(x=iter, y=C_colsum_res), col="red") +
  labs(
    title="Residual of Column Sum of C",
    x="Iteration",
    y="||1'C_hat - 1||_2"
  )

(p0 | p1 | p2)/(p3 | p4 | p5)
```

## Experiment 2:
We pull one value for each of the tuning parameter around the suitable range we discovered. Then, we contrast the solution of the two methods iteration by iteration, using two randomly generated `G_init` and `C_init` as initial values:

```{r exp2}
## change the initial values
## generate a G
G_init <- get_G(n_genes, n_subjects, n_cell_types, n_known_genes, n_good_cell_types)
C_init <- get_C(n_cell_types, n_subjects)

## one value for each parameter
a = 2^16
x = 16
b = 2^20

# a = 2^10
# x = 16
# b = 2^10

## run one numerical simulation
solve_direct <- PSMF_solve_test(
  M = M,
  G_0 = G0,
  G_init = G_init,
  C_init = C_init,
  n_markers = n_known_genes,
  n_good_cell_types = n_good_cell_types,
  alpha = a,
  xi = x,
  beta = b,
  eps = 1e-5,
  method = 'direct',
  Delta = Delta,
  G_true = G_true,
  C_true = C_true
)

solve_auxiliary <- PSMF_solve_test(
  M = M,
  G_0 = G0,
  G_init = G_init,
  C_init = C_init,
  n_markers = n_known_genes,
  n_good_cell_types = n_good_cell_types,
  alpha = a,
  xi = x,
  beta = b,
  eps = 1e-5,
  method = 'auxiliary',
  Delta = Delta,
  G_true = G_true,
  C_true = C_true
)
```

Collect the results:
```{r}
## output all the residuals we collected
direct_n_iter = solve_direct$n_iter 
direct_obj = solve_direct$obj
direct_M_res = solve_direct$M_res_vec
direct_G_res = solve_direct$G_res_vec %>% na.locf()
direct_C_res = solve_direct$C_res_vec %>% na.locf()
direct_C_colsum_res = solve_direct$C_colsum_res_vec %>% na.locf()
direct_G_fixed_res = solve_direct$G_fixed_res_vec %>% na.locf()

direct_df <- tibble(
  iter = 1:(direct_n_iter - 1),
  obj = direct_obj[-length(direct_obj)],
  M_res = direct_M_res[-length(direct_M_res)],
  G_res = direct_G_res,
  C_res = direct_C_res,
  G_fixed_res = direct_G_fixed_res,
  C_colsum_res = direct_C_colsum_res
)

aux_n_iter = solve_auxiliary$n_iter 
aux_obj = solve_auxiliary$obj
aux_M_res = solve_auxiliary$M_res_vec
aux_G_res = solve_auxiliary$G_res_vec %>% na.locf()
aux_C_res = solve_auxiliary$C_res_vec %>% na.locf()
aux_C_colsum_res = solve_auxiliary$C_colsum_res_vec %>% na.locf()
aux_G_fixed_res = solve_auxiliary$G_fixed_res_vec %>% na.locf()

aux_df <- tibble(
  iter = 1:(aux_n_iter),
  obj = aux_obj,
  M_res = aux_M_res,
  G_res = aux_G_res,
  C_res = aux_C_res,
  G_fixed_res = aux_G_fixed_res,
  C_colsum_res = aux_C_colsum_res
)
```

### Result 1: Differences of M_res, G_res, and C_res between two methods. 
```{r}
p0 <- direct_df %>% 
  ggplot(aes(x=iter, y=obj)) + 
  geom_line(col="green")

p0 <- p0 + 
  geom_line(data=aux_df, aes(x=iter, y=obj), col="red") +
  labs(
    title="Objectives",
    x="Iteration",
    y="Objective Function"
  )

p1 <- direct_df %>% 
  ggplot(aes(x=iter, y=M_res)) + 
  geom_line(col="green")

p1 <- p1 + 
  geom_line(data=aux_df, aes(x=iter, y=M_res), col="red") +
  labs(
    title="Residual of M",
    x="Iteration",
    y="||M - M_hat||_F"
  )

p2 <- direct_df %>% 
  ggplot(aes(x=iter, y=G_res)) + 
  geom_line(col="green")

p2 <- p2 + 
  geom_line(data=aux_df, aes(x=iter, y=G_res), col="red") +
  labs(
    title="Residual of G",
    x="Iteration",
    y="||G - G_hat||_F"
  )

p3 <- direct_df %>% 
  ggplot(aes(x=iter, y=C_res)) + 
  geom_line(col="green")

p3 <- p3 + 
  geom_line(data=aux_df, aes(x=iter, y=C_res), col="red") +
  labs(
    title="Residual of C",
    x="Iteration",
    y="||C - C_hat||_F"
  )

p4 <- direct_df %>% 
  ggplot(aes(x=iter, y=G_fixed_res)) + 
  geom_line(col="green")

p4 <- p4 + 
  geom_line(data=aux_df, aes(x=iter, y=G_fixed_res), col="red") +
  labs(
    title="Residual of Fixed Part of G",
    x="Iteration",
    y="||Delta * G_hat - C_0||_F"
  )

p5 <- direct_df %>% 
  ggplot(aes(x=iter, y=C_colsum_res)) + 
  geom_line(col="green")

p5 <- p5 + 
  geom_line(data=aux_df, aes(x=iter, y=C_colsum_res), col="red") +
  labs(
    title="Residual of Column Sum of C",
    x="Iteration",
    y="||1'C_hat - 1||_2"
  )

(p0 | p1 | p2)/(p3 | p4 | p5)
```